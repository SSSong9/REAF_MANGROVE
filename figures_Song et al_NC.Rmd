```{r}
setwd("C:\\Users\\Mangrove reforestation and afforestation") 
# Please change it to your own path, where file 'Supplementary Data.csv', 'EEZ_mangroveloss_final.csv' and 'Supplementary Data of Fig. S6.csv' exist.
```

```{r}
library("dplyr")
library("tidyr")
library("ggplot2")
library("rstatix")
library("ggpmisc")
library("ggpubr")
library("lme4")
library("ggrepel")
library("ggalluvial")
library("reshape2")
library("introdataviz")
```


```{r}
data=read.csv("Supplementary Data.csv",stringsAsFactors = FALSE,fileEncoding="latin1")

data=data%>%
  filter(ID<1000)%>%  # delete abnormal data
  filter(re_af!="")%>%
  filter(plant_nature!="")

colnames(data)

colnames(data)[c(19:23,25,28:33,35)]=c("BC_mean","ABC_mean","BBC_mean",
                                       "SCS_mean","SCS_mean_100","SC_mean","TECS_mean",
                                       "salinity_pore",
                                       "sand","silt","clay",
                                       "TN_mean","N.concentration_mean")  ## simplify column names
colnames(data)

```


```{r}
### Figure 1 ###
carbon=data
carbon[is.na(carbon)]=0
carbon=carbon[carbon$rehab_type!="",]
carbon=carbon[carbon$group=="restored",]
n=nrow(carbon)
carbon$all=rep(6,n)
carbon$region=factor(1:n)

mytheme=theme_bw()+
  theme(axis.text = element_text(family = "Helvetica",size=7),
  axis.text.x=element_text(face="plain",family = "Helvetica",size=7), 
        axis.text.y=element_text(face="plain",family = "Helvetica",size=7), 
        axis.title.y=element_text(face="plain",family = "Helvetica",size=7), 
        axis.title.x=element_text(face="plain",family = "Helvetica",size=7),  
        plot.title=element_text(hjust=0.5,vjust=0,family = "Helvetica",size=7),
        legend.text = element_text(family = "Helvetica",size=7),
        legend.title = element_text(face="plain",family = "Helvetica",size=7),
        panel.border = element_rect(fill=NA, size=0.4),
        legend.position = "bottom",
        strip.text.x = element_text(family = "Helvetica",size=7),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(colour = 'black', size = 0.3))

world = map_data('world')
p = ggplot(world, aes(long, lat)) +
    geom_map(map=world, aes(map_id=region), 
             fill="lightgrey", color="grey") +
    coord_quickmap() +
    scale_x_continuous(expand = c(0, 0))+
    scale_y_continuous(expand = c(0, 0),limits = c(-42,35))+
    scale_size(limits = c(0,500))+
    geom_point(data=subset(carbon,ABC_mean!=0),
               aes(x=Longitude,y=Latitude,
                   shape=re_af,size=ABC_mean,color=Age),
               alpha=0.5) +
    guides(shape = guide_legend(nrow = 2,
                                title="Rehabitation type",
                                override.aes = list(size = c(5,5))),
           size=guide_legend(title=expression(atop("",
                                                   atop(textstyle("Carbon density"),
                                                        atop(textstyle("(Mg C ha"^-1*")")))))))+
  labs(color=expression(atop("",atop(textstyle("Age"),
                                     atop(textstyle("(Year)"))))))+
  mytheme+
    theme(panel.grid.major =element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(color="white"),
        legend.background = element_blank(),
        legend.position = "bottom")+
    scale_colour_gradient(high = "#006400",low = "#89C35C") +
    xlab("Longitude")+
    ylab("Latitude")+
  annotate("text", x =-100, y =0,label="Ⅰ",parse = T,family="serif",size=2)+
  annotate("text", x =-20, y =10,label="Ⅱ",parse = T,family="serif",size=2)+
  annotate("text" ,x =60 ,y =10, label="Ⅲ",parse = T,family="serif",size=2)+
  annotate("text", x =90,y =15 , label="Ⅳ",parse=T,family="serif",size=2)+
  annotate("text", x =115 ,y =10, label="Ⅴ",parse = T,family="serif",size=2)

p1 =ggplot(data=subset(carbon,ABC_mean!=0),
           aes(x=Latitude,y=ABC_mean))+
    geom_point(aes(x=Latitude,y=ABC_mean,
                   size=ABC_mean,shape=re_af,color=Age),alpha=0.5,size=2) +
    geom_smooth(color="#006400",alpha=0.2,size=0.5)+
    guides(color = FALSE)+ 
    scale_x_continuous(expand = c(0, 0),limits = c(-42,35))+
  mytheme+
    theme(
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(color="white"),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        legend.title=element_blank(),
        legend.background = element_blank(),
        legend.position ="bottom")+
    scale_colour_gradient(high = "#006400", low = "#89C35C")+
  scale_y_continuous(limits = c(0,260),breaks=seq(0,250, by = 50) )+
  coord_flip()

p2 = ggplot(world, aes(long, lat)) +
    geom_map(map=world, 
             aes(map_id=region), fill="lightgrey", color="grey") +
    coord_quickmap() +
    scale_x_continuous(expand = c(0, 0))+
    scale_y_continuous(expand = c(0, 0),limits = c(-42,35))+
    scale_size(limits = c(0,500))+
    geom_point(data=subset(carbon,BBC_mean!=0),
               aes(x=Longitude,y=Latitude,
                   shape=re_af,size=BBC_mean,color=Age),
               alpha=0.5) +
  mytheme+
    theme(
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(color="white"),
        legend.title=element_blank(),
        legend.background = element_blank(),
        legend.position ="bottom")+
    scale_colour_gradient(high = "#09386C", low = "#4B97EC")+   
    xlab("Longitude")+
    ylab("Latitude")


p3 =ggplot(data=subset(carbon,BBC_mean!=0),
           aes(x=Latitude,y=BBC_mean))+
    geom_point(aes(x=Latitude,y=BBC_mean,
                   size=BBC_mean,shape=re_af,color=Age),alpha=0.5,size=2) +
    geom_smooth(color="#08298A",alpha=0.2,size=0.5)+
    guides(color = FALSE)+ 
    scale_x_continuous(expand = c(0, 0),limits = c(-42,35))+
    scale_y_continuous(expand = c(0, 0),limits = c(-5,80))+
  mytheme+
    theme(
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(color="white"),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        legend.title=element_blank(),
        legend.background = element_blank(),
        legend.position ="bottom")+
    scale_colour_gradient(high = "#09386C", low = "#4B97EC")+
  coord_flip()


p4 = ggplot(world, aes(long, lat)) +
    geom_map(map=world, aes(map_id=region), 
             fill="lightgrey", color="grey") +
    coord_quickmap() +
    scale_x_continuous(expand = c(0, 0))+
    scale_y_continuous(expand = c(0, 0),limits = c(-42,35))+
    scale_size(limits = c(0,500))+
    geom_point(data=subset(carbon,SCS_mean_100!=0),
               aes(x=Longitude,y=Latitude,
                   shape=re_af,size=SCS_mean_100,color=Age),
               alpha=0.5) +
  mytheme+
    theme(
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        legend.title=element_blank(),
        legend.background = element_blank(),
        legend.position ="bottom")+
    scale_colour_gradient(high = "#B8860B", low = "#E6BF83") + 
    xlab("Longitude")+
    ylab("Latitude")


p5 =ggplot(data=subset(carbon,SCS_mean_100!=0),
           aes(x=Latitude,y=SCS_mean_100))+
    geom_point(aes(x=Latitude,y=SCS_mean_100,
                   size=SCS_mean_100,
                   shape=re_af,color=Age),alpha=0.5,size=2) +
    geom_smooth(color="#B8860B",alpha=0.2,size=0.5)+
    guides(color = FALSE)+ 
    scale_x_continuous(expand = c(0, 0),limits = c(-42,35))+
  mytheme+
    theme(
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        legend.title=element_blank(),
        legend.background = element_blank(),
        legend.position ="bottom")+
    scale_colour_gradient(high = "#B8860B", low = "#E6BF83")+
    ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))+
  scale_y_continuous(limits = c(0,500))+
  coord_flip()


p6 =ggplot(data=carbon,aes(x=Longitude))+
    geom_point(data=subset(carbon,SCS_mean_100!=0),
               aes(x=Longitude,y=SCS_mean_100,
                   shape=re_af,size=Age),color="#B8860B",alpha=0.3) +
    geom_point(data=subset(carbon,BBC_mean!=0),
               aes(x=Longitude,y=BBC_mean,
                   shape=re_af,size=Age),color="#08298A",alpha=0.3) +
    geom_point(data=subset(carbon,ABC_mean!=0),
               aes(x=Longitude,y=ABC_mean,
                   shape=re_af,size=Age),color="#006400",alpha=0.3) +
    geom_smooth(data=subset(carbon,ABC_mean!=0),
                aes(x=Longitude,y=ABC_mean),color="#006400")+
    geom_smooth(data=subset(carbon,SCS_mean_100!=0),
                aes(x=Longitude,y=SCS_mean_100),color="#B8860B")+
    geom_smooth(data=subset(carbon,BBC_mean!=0),
                aes(x=Longitude,y=BBC_mean),color="#08298A")+
  mytheme+
    theme(panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        legend.title=element_blank(),
        legend.background = element_blank(),
        legend.position ="bottom")+
  ylab("carbon stock")


p7 =ggplot(data=carbon,aes(x=Longitude))+
    geom_point(data=subset(carbon,SCS_mean_100!=0),
               aes(x=Longitude,y=SCS_mean_100,
                   shape=re_af,size=Age),color="#B8860B",alpha=0.3) +
    geom_point(data=subset(carbon,BBC_mean!=0),
               aes(x=Longitude,y=BBC_mean,
                   shape=re_af,size=Age),color="#08298A",alpha=0.3) +
    geom_point(data=subset(carbon,ABC_mean!=0),
               aes(x=Longitude,y=ABC_mean,
                   shape=re_af,size=Age),color="#006400",alpha=0.3) +
    geom_smooth(data=subset(carbon,ABC_mean!=0),
                aes(x=Longitude,y=ABC_mean),color="#006400")+
    geom_smooth(data=subset(carbon,SCS_mean_100!=0),
                aes(x=Longitude,y=SCS_mean_100),color="#B8860B")+
    geom_smooth(data=subset(carbon,BBC_mean!=0),
                aes(x=Longitude,y=BBC_mean),color="#08298A")+
    scale_x_continuous(expand = c(0, 0),limits = c(0,180))+
  mytheme+
    theme(panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        legend.title=element_blank(),
        legend.background = element_blank(),
        legend.position ="bottom")+
  ylab(expression(paste("carbon density (Mg C ha"^-1*")")))


stat_box_data = function(y) {
  return( 
    data.frame(
      y = 550,
      label = paste('n =', length(y) 
                    )
    )
  )
}

carbon_melt=subset(melt(carbon,id.vars=c("Region","re_af"),
                 measure.vars=c("ABC_mean","BBC_mean","SCS_mean_100"),
                 variable.name = "carbon"),value!=0)

carbon_melt$Region=factor(carbon_melt$Region,levels=c("American Pacific Ocean",
                                                      "American Atlantic Ocean",
                                                      "Africa Indian Ocean",
                                                      "Asia Indian Ocean",
                                                      "Asia Pacific Ocean"))

p8=ggplot(carbon_melt,aes(x=Region,y=value,fill=carbon,color=carbon))+
   scale_fill_manual(labels=c("Aboveground biomass carbon",
                             "Belowground biomass carbon",
                             "Sediment carbon - 1m depth"),
                     values=c("#006400","#08298A","#B8860B"))+
   scale_color_manual(labels=c("Aboveground biomass carbon",
                             "Belowground biomass carbon",
                             "Sediment carbon - 1m depth"),
                      values=c("#006400","#08298A","#B8860B"))+
   geom_boxplot(outlier.size = -1,lwd=0.3, alpha = 0,show.legend = F,add.params = list(size = 0.5,alpha=0.5))+
   ggbeeswarm::geom_quasirandom(size=2, 
                                dodge.width = .75,alpha=.5)+
   guides(color = guide_legend(override.aes = list(size = c(5,5,5))))+
   stat_summary(
    fun.data = stat_box_data, 
    geom = "text",
    position = position_dodge(width = .75),show.legend = F,size=2,family="Helvetica")+
  mytheme+
   theme(
        axis.title.x=element_blank(), 
        legend.title=element_blank(),
        legend.position = "top",
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank())+
  ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))+
  scale_x_discrete(labels= c("(Ⅰ) American Pacific Ocean",
         "(Ⅱ) American Atlantic Ocean",
         "(Ⅲ) Africa Indian Ocean",
         "(Ⅳ) Asia Indian Ocean",
         "(Ⅴ) Asia Pacific Ocean"))
  

ggarrange(p8,labels = c("a"),
          ggarrange(p,p1,p2,p3,p4,p5,ncol=2,nrow=3,
                    widths = c(3,1),
                    labels=c("b","","c","","d",""),align = "v",
                    font.label=list(face="plain",family = "Helvetica",size=7,face="bold"),
                    common.legend = T,legend = "bottom"),
          font.label=list(face="plain",family = "Helvetica",size=7,face="bold"),
          nrow = 2,
          heights = c(1.5,3.5))

ggsave(path = "C:\\Users\\Mangrove reforestation and afforestation\\figures", 
       # Please change it into your own path
       filename="Fig.1.png",
       width = 178, height = 184, units = "mm")
```


```{r}
### Figure 2 ###
ABC=data %>% drop_na(ABC_mean)%>%filter(group=="restored")%>%filter(Age<=40)%>% 
  filter(Species!="")%>%
  filter(ABC_mean>0)%>%
  convert_as_factor(re_af,Species_2,plant_nature,climate.type_2)%>%mutate_all(type.convert)

BBC=data%>% drop_na(BBC_mean)%>%filter(group=="restored")%>%filter(Age<=40)%>%
  filter(Species!="")%>%
  filter(BBC_mean!="")%>%filter(BBC_mean>0)%>%
  convert_as_factor(re_af,Species_2,plant_nature,climate.type_2)%>%mutate_all(type.convert)

SCS=data%>% drop_na(SCS_mean_100)%>%filter(group=="restored")%>%filter(Age<=40)%>%
  filter(Species!="")%>%
  filter(SCS_mean_100>0)%>%
  convert_as_factor(re_af,Species_2,plant_nature,climate.type_2)%>%mutate_all(type.convert)

TECS=data%>% drop_na(TECS_mean)%>%filter(group=="restored")%>%filter(Age<=40)%>%
  filter(Species!="")%>%
  filter(TECS_mean>0)%>%
  convert_as_factor(re_af,Species_2,plant_nature,climate.type_2)%>%mutate_all(type.convert)


timeslice=function(data,time){
  l=nrow(data)
  timegroup=matrix(NA,nrow=l)
   for (i in c(1:l)){
    if (time[i]<=5){
      timegroup[i]="(0,5]"
    }else if(time[i]<=10){
      timegroup[i]="(5,10]"
    }else if(time[i]<=15){
      timegroup[i]="(10,15]"
    }else if(time[i]<=20){
      timegroup[i]="(15,20]"
    }else if(time[i]<=40){
      timegroup[i]="(20,40]"
    }
    else if(time[i]<=80){
        timegroup[i]="(40,80]"
    }
     }
  data=data.frame(data,timegroup=timegroup)
  return(data)
}  


ABC_select=timeslice(ABC,ABC$Age)
BBC_select=timeslice(BBC,BBC$Age)
SCS_select=timeslice(SCS,SCS$Age)
TECS_select=timeslice(TECS,TECS$Age)


ABC_select$timegroup=factor(ABC_select$timegroup,levels =
                              c("(0,5]","(5,10]","(10,15]","(15,20]","(20,40]","(40,80]"))
BBC_select$timegroup=factor(BBC_select$timegroup,levels = 
                              c("(0,5]","(5,10]","(10,15]","(15,20]","(20,40]","(40,80]"))
SCS_select$timegroup=factor(SCS_select$timegroup,levels =
                              c("(0,5]","(5,10]","(10,15]","(15,20]","(20,40]","(40,80]"))
TECS_select$timegroup=factor(TECS_select$timegroup,levels =
                               c("(0,5]","(5,10]","(10,15]","(15,20]","(20,40]","(40,80]"))


ABC_select=ABC_select%>%
  filter(timegroup!="(40,80]")
BBC_select=BBC_select%>%
  filter(timegroup!="(40,80]")
SCS_select=SCS_select%>%
  filter(timegroup!="(40,80]")
TECS_select=TECS_select%>%
  filter(timegroup!="(40,80]")


ABC_select_mean = ABC_select %>% 
  dplyr::group_by(timegroup,re_af) %>% 
  dplyr::summarize(average = mean(ABC_mean),
                   std=sd(ABC_mean,na.rm = TRUE)/sqrt(length(ABC_mean)),
                   median=median(ABC_mean)) %>%
  ungroup()

BBC_select_mean = BBC_select %>% 
  dplyr::group_by(timegroup,re_af) %>% 
  dplyr::summarize(average = mean(BBC_mean,na.rm=TRUE),
                   std=sd(BBC_mean,na.rm = TRUE)/sqrt(length(BBC_mean)),
                   median=median(BBC_mean)) %>%
  ungroup()

SCS_select_mean = SCS_select %>% 
  dplyr::group_by(timegroup,re_af) %>% 
  dplyr::summarize(average = mean(SCS_mean_100,na.rm=TRUE),
                   std=sd(SCS_mean_100,na.rm = TRUE)/sqrt(length(SCS_mean_100)),
                   median=median(SCS_mean_100)) %>%
  ungroup()

TECS_select_mean = TECS_select %>% 
  dplyr::group_by(timegroup,re_af) %>% 
  dplyr::summarize(average = mean(TECS_mean,na.rm=TRUE),
                   std=sd(TECS_mean,na.rm = TRUE)/sqrt(length(TECS_mean)),
                   median=median(TECS_mean)) %>%
  ungroup()

meansd=rbind(ABC_select_mean,BBC_select_mean,SCS_select_mean,TECS_select_mean)
write.csv(meansd,"mean_sd_group.csv")

mytheme=theme_bw()+
  theme(axis.text = element_text(family = "Helvetica",size=7),
  axis.text.x=element_text(face="plain",family = "Helvetica",size=7), 
        axis.text.y=element_text(face="plain",family = "Helvetica",size=7), 
        axis.title.y=element_text(face="plain",family = "Helvetica",size=7), 
        axis.title.x=element_blank(), 
        plot.title=element_text(hjust=0.5,vjust=0,family = "Helvetica",size=7),
        legend.text = element_text(family = "Helvetica",size=7),
        legend.title = element_blank(),
        panel.border = element_rect(fill=NA, size=0.4),
        legend.position = "bottom",
        strip.text.x = element_text(family = "Helvetica",size=7),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(colour = 'black', size = 0.3))

P1=ggplot(ABC_select,aes(x=timegroup,y=ABC_mean,color=re_af))+
  geom_boxplot(outlier.shape = NA,lwd=0.3)+
  stat_compare_means(size=3,aes(label = ..p.signif..),label.y = 225,hide.ns = TRUE,show.legend = F)+
  scale_color_manual(values = c("reforestation"="#326232","afforestation"="#45DA54"))+
  stat_summary(fun.y=mean, geom="point", shape=1, size=1, aes(color=re_af),
             position = position_dodge2(width = 0.75,
                                        preserve = "single"))+
  geom_line(data = ABC_select_mean, 
            mapping = aes(x = timegroup, y = average,group=re_af),size=0.7,position = position_dodge())+
  mytheme+
    ggtitle(expression("Aboveground biomass carbon"))+
    xlab("Age Group (year)")+
    ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))  


P2=ggplot(BBC_select,aes(x=timegroup,y=BBC_mean,color=re_af))+
  geom_boxplot(outlier.shape = NA,lwd=0.3)+
  stat_compare_means(size=3,aes(label = ..p.signif..),label.y = 100,hide.ns = TRUE,show.legend = F)+
  scale_color_manual(values = c("reforestation"="#09386C","afforestation"="#70ABEB"))+
  stat_summary(fun.y=mean, geom="point", shape=1, size=1, aes(color=re_af),
             position = position_dodge2(width = 0.75,
                                        preserve = "single"))+
  geom_line(data = BBC_select_mean, 
            mapping = aes(x = timegroup, y = average,group=re_af),size=0.7,position = position_dodge())+
  mytheme+
    ggtitle(expression("Belowground biomass carbon"))+
   scale_y_continuous(limits = c(0,100))+
    xlab("Age Group (year)")+
    ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))  


P3=ggplot(SCS_select,aes(x=timegroup,y=SCS_mean_100,color=re_af))+
  geom_boxplot(outlier.shape = NA,lwd=0.3)+
  stat_compare_means(size=3,aes(label = ..p.signif..),label.y = 480,hide.ns = TRUE,show.legend = F)+
  scale_color_manual(values = c("reforestation"="#B8860B","afforestation"="#F3D33A"))+
    stat_summary(fun.y=mean, geom="point", shape=1, size=1, aes(color=re_af),
             position = position_dodge2(width = 0.75,
                                        preserve = "single"))+
    geom_line(data = SCS_select_mean, 
            mapping = aes(x = timegroup, y = average,group=re_af),size=0.7,position = position_dodge())+
    mytheme+
    theme(axis.title.x=element_text(face="plain",family = "Helvetica",size=7))+
    ggtitle(expression("Sediment carbon - 1m depth"))+
    xlab("Age Group (year)")+
    ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))  


P4=ggplot(TECS_select,aes(x=timegroup,y=TECS_mean,color=re_af))+
  geom_boxplot(outlier.shape = NA,lwd=0.3)+
  stat_compare_means(size=3,aes(label = ..p.signif..),label.y = 510,hide.ns = TRUE,show.legend = F)+
  scale_color_manual(values = c("reforestation"="#AD3818","afforestation"="#FCB29E"))+
  stat_summary(fun.y=mean, geom="point", shape=1, size=1, aes(color=re_af),
             position = position_dodge2(width = 0.75,
                                        preserve = "single"))+
  geom_line(data = TECS_select_mean, 
            mapping = aes(x = timegroup, y = average,group=re_af),size=0.7,position = position_dodge())+
  mytheme+
    theme(axis.title.x=element_text(face="plain",family = "Helvetica",size=7))+
    ggtitle(expression("Total ecosystem carbon"))+
    xlab("Age Group (year)")+
    ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))  


ggarrange(P1,P2,P3,P4, ncol = 2, nrow =2 ,labels="auto",heights=c(1,1.05),font.label=list(face="plain",family = "Helvetica",size=7,face="bold"),
             legend ="bottom",common.legend = T)

ggsave(path = "C:\\Users\\Mangrove reforestation and afforestation\\figures", 
       # change it into your own path
       filename="Fig.2.png",
       width = 180, height = 120, units = "mm",dpi=300)

```

```{r}
### Table S1 ###
fm=lmer(ABC_mean~Age*re_af+(1|ID),data=ABC)

summary(fm)
Anova(fm,type = 3)

fm_1=lmer(ABC_mean~log(Age)*re_af+(1|ID),data=ABC)

summary(fm_1)
Anova(fm_1,type = 3)

AIC(fm,fm_1)

fm2=lmer(BBC_mean~Age*re_af+(1|ID),data=BBC)

summary(fm2)
Anova(fm2,type = 3)

fm2_1=lmer(BBC_mean~log(Age)*re_af+(1|ID),data=BBC)

summary(fm2_1)
Anova(fm2_1,type = 3)

AIC(fm2,fm2_1)


fm3=lmer(SCS_mean_100~Age*re_af+(1|ID),data=SCS)

summary(fm3)
Anova(fm3,type = 3)

fm3_1=lmer(SCS_mean_100~log(Age)*re_af+(1|ID),data=SCS)

summary(fm3_1)
Anova(fm3_1,type = 3)

AIC(fm3,fm3_1)


fm4=lmer(TECS_mean~Age*re_af+(1|ID),data=TECS)

summary(fm4)
Anova(fm4,type = 3)

fm4_1=lmer(TECS_mean~log(Age)*re_af+(1|ID),data=TECS)

summary(fm4_1)
Anova(fm4_1,type = 3)

AIC(fm4,fm4_1)

```

```{r}
#### Figure S5 ####
ABC_select=ABC%>%filter(Age %in% c(15:40))
BBC_select=BBC%>%filter(Age %in% c(15:40))
SCS_select=SCS%>%filter(Age %in% c(15:40))
TECS_select=TECS%>%filter(Age %in% c(15:40))

ABC_select$inter=interaction(ABC_select$re_af,ABC_select$climate.type_2)
BBC_select$inter=interaction(BBC_select$re_af,BBC_select$climate.type_2)
SCS_select$inter=interaction(SCS_select$re_af,SCS_select$climate.type_2)
TECS_select$inter=interaction(TECS_select$re_af,TECS_select$climate.type_2)

ABC_select=ABC_select%>%filter(inter!="reforestation.subtropical")
BBC_select=BBC_select%>%filter(inter!="reforestation.subtropical")

mytheme=theme_bw()+
  theme(axis.text = element_text(family = "Helvetica",size=6),
  axis.text.x=element_text(face="plain",family = "Helvetica",size=6), 
        axis.text.y=element_text(face="plain",family = "Helvetica",size=6), 
        axis.title.y=element_text(face="plain",family = "Helvetica",size=6), 
        axis.title.x=element_blank(), 
        plot.title=element_text(hjust=0.5,vjust=0,family = "Helvetica",size=6),
        legend.text = element_text(family = "Helvetica",size=6),
        legend.title = element_blank(),
        panel.border = element_rect(fill=NA, size=0.4),
        legend.position = "bottom",
        strip.text.x = element_text(family = "Helvetica",size=6),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(colour = 'black', size = 0.3))


P1=ggboxplot(ABC_select,x="inter",y="ABC_mean",
          color = "inter", 
          add = "jitter", 
          legend = "none",lwd=0.3)+
  mytheme+
    ggtitle(expression("Aboveground biomass carbon"))+
    xlab("rehab type")+
    ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))+  
      geom_signif(test="wilcox.test", 
               comparisons = list(c("afforestation.subtropical","afforestation.tropical"),
                                  c("afforestation.tropical","reforestation.tropical")),
               step_increase = 0.1,
               size=0.3, 
               textsize=2)

P2=ggboxplot(BBC_select,x="inter",y="BBC_mean",
          color = "inter", 
          add = "jitter", 
          legend = "none",lwd=0.3)+
  mytheme+
    ggtitle(expression("Belowground biomass carbon"))+
    xlab("rehab type")+
    ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))+  
      geom_signif(test="wilcox.test", 
               comparisons = list(c("afforestation.subtropical","afforestation.tropical"),
                                  c("afforestation.tropical","reforestation.tropical")),
               step_increase = 0.1,
               size=0.3, 
               textsize=2)

P3=ggboxplot(SCS_select,x="inter",y="SCS_mean_100",
          color = "inter", 
          add = "jitter", 
          legend = "none",lwd=0.3)+
  mytheme+
    ggtitle(expression("Sediment carbon - 1m depth"))+
    xlab("rehab type")+
    ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))+  
      geom_signif(test="wilcox.test", 
               comparisons = list(c("afforestation.subtropical","afforestation.tropical"),
                                  c("afforestation.tropical","reforestation.tropical")),
               step_increase = 0.1,
               size=0.3, 
               textsize=2)


P4=ggboxplot(TECS_select,x="inter",y="TECS_mean",
          color = "inter", 
          add = "jitter", 
          legend = "none",lwd=0.3)+
  mytheme+
    ggtitle(expression("Total ecosystem carbon"))+
    xlab("rehab type")+
    ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))+  
    geom_signif(test="wilcox.test", 
               comparisons = list(c("afforestation.subtropical","afforestation.tropical"),
                                  c("afforestation.tropical","reforestation.tropical")),
               step_increase = 0.1,
               size=0.3, 
               textsize=2)

ggarrange(P1,P2,P3,P4, ncol = 2, nrow =2 ,labels="auto",font.label=list(face="plain",family = "Helvetica",size=7,face="bold"),
             legend ="bottom",common.legend = T)

ggsave(path = "C:\\Users\\Mangrove reforestation and afforestation\\figures",
       filename="Fig.S5.png",
       width = 170, height = 110, units = "mm",dpi=300)

```

```{r}
### Figure 3 ###
data$re_af=factor(data$re_af,level=c("afforestation","reforestation"))
data_1=data%>%filter(group!="intact")

data_1$SC_mean=as.numeric(data_1$SC_mean)

mytheme=theme_bw()+
  theme(axis.text = element_text(family = "Helvetica",size=5),
  axis.text.x=element_text(face="plain",family = "Helvetica",size=5), 
        axis.text.y=element_text(face="plain",family = "Helvetica",size=5), 
        axis.title.y=element_text(face="plain",family = "Helvetica",size=5), 
        axis.title.x=element_blank(), 
        plot.title=element_text(hjust=0.5,vjust=0,family = "Helvetica",size=5),
        legend.text = element_text(family = "Helvetica",size=5),
        legend.title = element_blank(),
        panel.border = element_rect(fill=NA, size=0.4),
        legend.position = "bottom",
        strip.text.x = element_text(family = "Helvetica",size=5),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(colour = 'black', size = 0.3),
        axis.ticks.length=unit(0.5, "mm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-5,0,-5,0))


P1=ggplot(ABC,aes(x=salinity_pore,y=ABC_mean))+
   geom_point(aes(color=re_af),
              size=1,alpha=0.6)+
      geom_smooth(color="#006400",
                  fill="grey",
              formula=y ~ x,
              method=lm,
              alpha=0.2,
              size=0.5)+
      stat_poly_eq(formula = y~x,
               aes(label = paste(..rr.label..,..p.value.label..,sep = "~~~")),
               size=1.8,
               label.y = "top", label.x = "left",
               parse = TRUE)+
    scale_color_manual(values = c("reforestation"="#006400","afforestation"="#51C151"))+
  mytheme+
    xlab(expression(paste("Sediment porewater salinity (psu)")))+
    ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))

P5=ggboxplot(data_1,x="re_af",y="salinity_pore",
          color = "re_af", 
          add = "jitter",
          legend = "none",
          lwd=0.3,
          add.params = list(size = 0.6,alpha=0.5))+
  mytheme+
  theme(axis.text.x=element_text(hjust = 0.5,colour="white",size=3))+
    scale_color_manual(values = c("reforestation"="#006400","afforestation"="#51C151"))+
  stat_compare_means(size=2,aes(label = ..p.signif..),label.x = 1.5,label.y = 58,hide.ns = TRUE)+
  ylab(expression(paste("Sediment porewater salinity (psu)")))

P2=ggplot(ABC,aes(x=SC_mean,y=ABC_mean))+
   geom_point(aes(color=re_af),
              size=1,alpha=0.6)+
      geom_smooth(color="#006400",
                  fill="grey",
              formula=y ~ x,
              method=lm,
              alpha=0.2,
              size=0.5)+
      stat_poly_eq(formula = y~x,
               aes(label = paste(..rr.label..,..p.value.label..,sep = "~~~")),
               size=1.8,
               label.y = "top", label.x = "left",
               parse = TRUE)+
    scale_color_manual(values = c("reforestation"="#006400","afforestation"="#51C151"))+
  mytheme+
    xlab(expression(paste("Sediment organic carbon content (%)")))+
    ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))


P6=ggboxplot(data_1,x="re_af",y="SC_mean",
          color = "re_af", 
          add = "jitter",
          legend = "none",
          lwd=0.3,
          add.params = list(size = 0.6, alpha=0.5))+
    scale_color_manual(values = c("reforestation"="#006400","afforestation"="#51C151"))+
  stat_compare_means(size=2,aes(label = ..p.signif..),label.x = 1.5,label.y = 20)+
  mytheme+
  theme(axis.text.x=element_text(hjust = 0.5,colour="white",size=3))+
      scale_y_continuous(limits=c(-2,22),breaks = seq(0,20,5),expand=c(0,0))+
    ylab(expression(paste("Sediment organic carbon content (%)")))


P3=ggplot(ABC,aes(x=N.concentration_mean,y=ABC_mean))+
   geom_point(aes(color=re_af),
              size=1,alpha=0.6)+
      geom_smooth(color="#006400",
                  fill="grey",
              formula=y ~ x,
              method=lm,
              alpha=0.2,
              size=0.5)+
      stat_poly_eq(formula = y~x,
               aes(label = paste(..rr.label..,..p.value.label..,sep = "~~~")),
               size=1.8,
               label.y = "top", label.x = "left",
               parse = TRUE)+
    scale_color_manual(values = c("reforestation"="#006400","afforestation"="#51C151"))+
  mytheme+
    xlab(expression(paste("Sediment nitrogen content (%)")))+
    ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))


P7=ggboxplot(data_1,x="re_af",y="N.concentration_mean",
          color = "re_af", 
          add = "jitter",
          legend = "none",
          lwd=0.3,
          add.params = list(size = 0.6, alpha = 0.5))+
    scale_color_manual(values = c("reforestation"="#006400","afforestation"="#51C151"))+
  stat_compare_means(size=2,aes(label = ..p.signif..),label.x = 1.5,label.y = 0.9)+
  mytheme+
  theme(axis.text.x=element_text(hjust = 0.5,colour="white",size=3))+
  scale_y_continuous(limits = c(0,1))+
  ylab(expression(paste("Sediment nitrogen content (%)")))

ggarrange(P2,P6,P3,P7,P1,P5, ncol = 2, nrow =3,widths = c(2,1) ,labels="auto",common.legend = TRUE,legend="bottom",align = "v",font.label=list(face="plain",family = "Helvetica",size=7,face="bold"))

ggsave(path = "C:\\Users\\Mangrove reforestation and afforestation\\figures",
       filename="Fig.3.png",
       width = 88, height = 120, units = "mm",dpi=300)

```

```{r}
### Figure S3 ###
RS=data_1

RS_melt_nutrient=melt(RS,
              id.vars = c("BA","re_af"),
             measure.vars = c("salinity_pore",
                              "silt",
                              "clay",
                              "sand",
                              "SC_mean",
                              "TN_mean",
                              "N.concentration_mean",
                              "C.N",
                              "initial_SC",
                              "initial_TN",
                              "initial_N",
                              "initial_CN",
                              "initial_salinity",
                              "initial_pH",
                              "initial_clay",
                              "initial_silt",
                              "initial_sand",
                              "pH"),
             variable.name = "initial")%>%
  mutate_all(type.convert)

mytheme=theme_bw()+
  theme(axis.text = element_text(family = "Helvetica",size=5),
  axis.text.x=element_text(face="plain",family = "Helvetica",size=5), 
        axis.text.y=element_text(face="plain",family = "Helvetica",size=5), 
        axis.title.y=element_text(face="plain",family = "Helvetica",size=5), 
        axis.title.x=element_text(face="plain",family = "Helvetica",size=5),  
        plot.title=element_text(hjust=0.5,vjust=0,family = "Helvetica",size=5),
        legend.text = element_text(family = "Helvetica",size=5),
        legend.title = element_blank(),
        panel.border = element_rect(fill=NA, size=0.4),
        legend.position = "bottom",
        strip.text.x = element_text(family = "Helvetica",size=5),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(size = 0.3),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-5,10,-5,10))


P2=ggplot(RS,aes(x=salinity_pore,y=BA))+
   geom_point(aes(color=re_af),
              size=2,alpha=0.6)+
      geom_smooth(color="#4B97EC",
              formula=y ~ x,
              method=lm,
              alpha=0.2,lwd=0.3)+
      stat_poly_eq(formula = y~x,
               aes(label = paste(..rr.label..,..p.value.label..,sep = "~~~")),
               size=2,
               label.y = "top", label.x = "left",
               parse = TRUE)+
  mytheme+
  scale_x_continuous(limits=c(15,70),expand=c(0,0))+
  scale_y_continuous(limits=c(0,2),expand=c(0,0))+
    xlab("Sediment porewater salinity (psu)")+
    ylab("BBC/ABC")


P4=ggboxplot(data,x="re_af",y="salinity_pore",
          color = "re_af", 
          add = "jitter", 
          legend = "none",
          lwd=0.3,
          add.params = list(size = 0.6, alpha = 0.5))+
  stat_compare_means(size=5,aes(label = ..p.signif..),label.x = 1.5,label.y = 80,hide.ns = TRUE)+
  mytheme+
  theme(axis.title.x = element_text(hjust = 0.5,colour="white",size=5),
        axis.text.x = element_text(face="plain",color="white",size=5))+
  ylab(expression(paste("Sediment porewater salinity (psu)")))
P4


ggarrange(P2,P4,ncol = 2,nrow=1,widths = c(2,1),labels="auto",legend = "bottom",common.legend = T,font.label=list(face="plain",family = "Helvetica",size=7,face="bold"))


ggsave(path = "C:\\Users\\Mangrove reforestation and afforestation\\figures",
       filename="Fig.S3.png",
       width = 88, height = 50, units = "mm")

```

```{r}
#### Fig. 4 + Table S4 ####
data=read.csv("Supplementary Data.csv",stringsAsFactors = FALSE,fileEncoding="latin1")

data=data%>%
  filter(ID<1000)%>%  # delete abnormal data
  filter(re_af!="")%>%
  filter(Age<=40)

colnames(data)[c(19:23,25,28:33,35)]=c("BC_mean","ABC_mean","BBC_mean",
                                       "SCS_mean","SCS_mean_100","SC_mean","TECS_mean",
                                       "salinity_pore",
                                       "sand","silt","clay",
                                       "TN_mean","N.concentration_mean")

ABC=data %>% drop_na(ABC_mean)%>%filter(group=="restored")%>% 
  filter(Species!="")%>%
  filter(ABC_mean>0)%>%
  convert_as_factor(re_af,Species_2,plant_nature,climate.type_2)%>%mutate_all(type.convert)

BBC=data%>% drop_na(BBC_mean)%>%filter(group=="restored")%>%
  filter(Species!="")%>%
  filter(BBC_mean!="")%>%filter(BBC_mean>0)%>%
  convert_as_factor(re_af,Species_2,plant_nature,climate.type_2)%>%mutate_all(type.convert)

SCS=data%>% drop_na(SCS_mean_100)%>%filter(group!="intact")%>%
  filter(Species!="")%>%
  filter(SCS_mean_100>0)%>%
  convert_as_factor(re_af,Species_2,plant_nature,climate.type_2)%>%mutate_all(type.convert)

TECS=data%>% drop_na(TECS_mean)%>%filter(group!="intact")%>%
  filter(Species!="")%>%
  filter(TECS_mean>0)%>%
  convert_as_factor(re_af,Species_2,plant_nature,climate.type_2)%>%mutate_all(type.convert)


ABC_ref=ABC%>%filter(re_af=="reforestation")%>%arrange(Age)
ABC_aff=ABC%>%filter(re_af=="afforestation")%>%arrange(Age)

Gompertz = function(x, Asym, b2, b3) Asym*exp(-b2*b3^x)
fit_ref_ABC = nls(ABC_mean~Gompertz(Age,Asym,b2,b3),data=ABC_ref,start=list(Asym=115.72,b2=1.4,b3=0.95))
fit_aff_ABC = nls(ABC_mean~Gompertz(Age,Asym,b2,b3),data=ABC_aff,start=list(Asym=91.55,b2=1.4,b3=0.9))

BBC_ref=BBC%>%filter(re_af=="reforestation")%>%arrange(Age)
BBC_aff=BBC%>%filter(re_af=="afforestation")%>%arrange(Age)

fit_ref_BBC = nls(BBC_mean~Gompertz(Age,Asym,b2,b3),data=BBC_ref,start=list(Asym=95.56,b2=2.74,b3=0.96))
fit_aff_BBC = nls(BBC_mean~Gompertz(Age,Asym,b2,b3),data=BBC_aff,start=list(Asym=75,b2=2,b3=0.96))

SCS_ref=SCS%>%filter(re_af=="reforestation")%>%arrange(Age)
SCS_aff=SCS%>%filter(re_af=="afforestation")%>%arrange(Age)

Gompertz = function(x, Asym, b2, b3) Asym*exp(-b2*b3^x)
fit_ref_SCS = nls(SCS_mean_100~Gompertz(Age,Asym,b2,b3),data=SCS_ref,start=list(Asym=510,b2=0.67,b3=0.9))
fit_aff_SCS = nls(SCS_mean_100~Gompertz(Age,Asym,b2,b3),data=SCS_aff,start=list(Asym=250,b2=1.4,b3=1.1))

TECS_ref=TECS%>%filter(re_af=="reforestation")%>%arrange(Age)
TECS_aff=TECS%>%filter(re_af=="afforestation")%>%arrange(Age)

Gompertz = function(x, Asym, b2, b3) Asym*exp(-b2*b3^x)
fit_ref_TECS = nls(TECS_mean~Gompertz(Age,Asym,b2,b3),data=TECS_ref,start=list(Asym=410,b2=0.67,b3=0.9))
fit_aff_TECS = nls(TECS_mean~Gompertz(Age,Asym,b2,b3),data=TECS_aff,start=list(Asym=200,b2=1.4,b3=0.9))

am=function(fit,name){
  a=summary(fit)$sigma
  b=coef(fit)
  c=nlstools::confint2(fit)
  e=cbind(rep(name,3),rep(a,3),b,c)
  return(e)
}

param=rbind(am(fit_aff_ABC,"fit_aff_ABC"),
      am(fit_aff_BBC,"fit_aff_BBC"),
      am(fit_aff_SCS,"fit_aff_SCS"),
      am(fit_aff_TECS,"fit_aff_TECS"),
      am(fit_ref_ABC,"fit_ref_ABC"),
      am(fit_ref_BBC,"fit_ref_BBC"),
      am(fit_ref_SCS,"fit_ref_SCS"),
      am(fit_ref_TECS,"fit_ref_TECS"))
write.csv(param,"param_nls.csv") ### Table S4


ABC_ref_result=data.frame(investr::predFit(fit_ref_ABC,newdata=data.frame(Age=seq(0,40,by=1)),interval="confidence",level=0.95))
ABC_aff_result=data.frame(investr::predFit(fit_aff_ABC,newdata=data.frame(Age=seq(0,40,by=1)),interval="confidence",level=0.95))

BBC_ref_result=data.frame(investr::predFit(fit_ref_BBC,newdata=data.frame(Age=seq(0,40,by=1)),interval="confidence",level=0.95))
BBC_aff_result=data.frame(investr::predFit(fit_aff_BBC,newdata=data.frame(Age=seq(0,40,by=1)),interval="confidence",level=0.95))

SCS_ref_result=data.frame(investr::predFit(fit_ref_SCS,newdata=data.frame(Age=seq(0,40,by=1)),interval="confidence",level=0.95))
SCS_aff_result=data.frame(investr::predFit(fit_aff_SCS,newdata=data.frame(Age=seq(0,40,by=1)),interval="confidence",level=0.95))

TECS_ref_result=data.frame(investr::predFit(fit_ref_TECS,newdata=data.frame(Age=seq(0,40,by=1)),interval="confidence",level=0.95))
TECS_aff_result=data.frame(investr::predFit(fit_aff_TECS,newdata=data.frame(Age=seq(0,40,by=1)),interval="confidence",level=0.95))

mytheme=theme_bw()+
  theme(axis.text = element_text(family = "Helvetica",size=7),
  axis.text.x=element_text(face="plain",family = "Helvetica",size=7), 
        axis.text.y=element_text(face="plain",family = "Helvetica",size=7), 
        axis.title.y=element_text(face="plain",family = "Helvetica",size=7), 
        axis.title.x=element_text(face="plain",family = "Helvetica",size=7),  
        plot.title=element_text(hjust=0.5,vjust=0,family = "Helvetica",size=7),
        legend.text = element_text(family = "Helvetica",size=7),
        legend.title = element_text(face="plain",family = "Helvetica",size=7),
        panel.border = element_rect(fill=NA, size=0.4),
        legend.position = "bottom",
        strip.text.x = element_text(family = "Helvetica",size=7),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(colour = 'black', size = 0.3))

year=c(0:40,0:40)
type=c(rep("reforestation",41),rep("afforestation",41))
TECS_all=cbind(year,rbind(TECS_ref_result,TECS_aff_result),type)

p1=ggplot(TECS_all,aes(x=year))+
  geom_point(data=TECS,aes(x=Age,y=TECS_mean,color=re_af),size=2, alpha=0.6)+
  geom_line(aes(x=year,y=fit,color=type),size=0.5,linetype=1)+
  geom_ribbon(aes(ymin=lwr,ymax=upr,fill=type),alpha=0.2)+
  scale_color_manual(values = c("reforestation"="#AD3818","afforestation"="#FCB29E"))+
  scale_fill_manual(values = c("reforestation"="#AD3818","afforestation"="#FCB29E"))+
  mytheme+
        scale_x_continuous(limits=c(0,45),expand = c(0,0))+
        xlab("Mangrove age (Year)")+
        ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))


year=c(0:40,0:40)
type=c(rep("reforestation",41),rep("afforestation",41))
ABC_all=cbind(year,rbind(ABC_ref_result,ABC_aff_result),type)

p2=ggplot(ABC_all,aes(x=year))+
    geom_point(data=ABC,aes(x=Age,y=ABC_mean,color=re_af),size=2, alpha=0.6)+
  geom_line(aes(x=year,y=fit,color=type),size=0.5,linetype=1)+
  geom_ribbon(aes(ymin=lwr,ymax=upr,fill=type),alpha=0.2)+
  scale_color_manual(values = c("reforestation"="#006400","afforestation"="#51C151"))+
  scale_fill_manual(values = c("reforestation"="#006400","afforestation"="#51C151"))+
  mytheme+
        scale_x_continuous(limits=c(0,45),expand = c(0,0))+
        xlab("Mangrove age (Year)")+
        ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))


year=c(0:40,0:40)
type=c(rep("reforestation",41),rep("afforestation",41))
BBC_all=cbind(year,rbind(BBC_ref_result,BBC_aff_result),type)

p3=ggplot(BBC_all,aes(x=year))+
    geom_point(data=BBC,aes(x=Age,y=BBC_mean,color=re_af),size=2, alpha=0.6)+
  geom_line(aes(x=year,y=fit,color=type),size=0.5,linetype=1)+
  geom_ribbon(aes(ymin=lwr,ymax=upr,fill=type),alpha=0.2)+
  scale_color_manual(values = c("reforestation"="#09386C","afforestation"="#70ABEB"))+
  scale_fill_manual(values = c("reforestation"="#09386C","afforestation"="#70ABEB"))+
  mytheme+
        scale_x_continuous(limits=c(0,45),expand = c(0,0))+
        xlab("Mangrove age (Year)")+
        ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))

year=c(0:40,0:40)
type=c(rep("reforestation",41),rep("afforestation",41))
SCS_all=cbind(year,rbind(SCS_ref_result,SCS_aff_result),type)

p5=ggplot(SCS_all,aes(x=year))+
    geom_point(data=SCS,aes(x=Age,y=SCS_mean_100,color=re_af),size=2, alpha=0.6)+
  geom_line(aes(x=year,y=fit,color=type),size=0.5,linetype=1)+
  geom_ribbon(aes(ymin=lwr,ymax=upr,fill=type),alpha=0.2)+
  scale_color_manual(values = c("reforestation"="#B8860B","afforestation"="#F3D33A"))+
  scale_fill_manual(values = c("reforestation"="#B8860B","afforestation"="#F3D33A"))+
  mytheme+
        scale_x_continuous(limits=c(0,45),expand = c(0,0))+
        xlab("Mangrove age (Year)")+
        ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))

TECS_ref_result=data.frame(investr::predFit(fit_ref_TECS,newdata=data.frame(Age=seq(0,40,by=1)),interval="confidence",level=0.95))
TECS_aff_result=data.frame(investr::predFit(fit_aff_TECS,newdata=data.frame(Age=seq(0,40,by=1)),interval="confidence",level=0.95))

TECS_ref_result[,1]=TECS_ref_result[,1]-TECS_ref_result[1,1]
TECS_ref_result[,2]=TECS_ref_result[,2]-TECS_ref_result[1,2]
TECS_ref_result[,3]=TECS_ref_result[,3]-TECS_ref_result[1,3]
TECS_aff_result[,1]=TECS_aff_result[,1]-TECS_aff_result[1,1]
TECS_aff_result[,2]=TECS_aff_result[,2]-TECS_aff_result[1,2]
TECS_aff_result[,3]=TECS_aff_result[,3]-TECS_aff_result[1,3]

year=c(0:40,0:40)
type=c(rep("reforestation",41),rep("afforestation",41))
TECS_all=cbind(year,rbind(TECS_ref_result,TECS_aff_result),type)

p4=ggplot(TECS_all,aes(x=year))+
  geom_line(aes(x=year,y=fit,color=type),size=1,linetype=1)+
  geom_ribbon(aes(ymin=lwr,ymax=upr,fill=type),alpha=0.2)+
  scale_color_manual(values = c("reforestation"="#AD3818","afforestation"="#FCB29E"))+
  scale_fill_manual(values = c("reforestation"="#AD3818","afforestation"="#FCB29E"))+
  mytheme+
        scale_x_continuous(limits=c(0,45),expand = c(0,0))+
        xlab("Mangrove age (Year)")+
        ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))

write.csv(ABC_all,"ABC_all.csv")
write.csv(BBC_all,"BBC_all.csv")
write.csv(SCS_all,"SCS_all.csv")
write.csv(TECS_all,"TECS_all.csv")


library("sf")
library("rnaturalearth")
library("rnaturalearthdata")
world = ne_countries(scale = "medium", returnclass = "sf")

world_tecs=read.csv("EEZ_mangroveloss_final.csv") ### file include mangrove loss area in each country/EEZ
world_tecs$reforestation.Tg.CO2_40=world_tecs$area.ha*(ABC_ref_result$fit[41]+BBC_ref_result$fit[41]+SCS_ref_result$fit[41]-SCS_ref_result$fit[1])/10^6/12*44

world_tecs$afforestation.Tg.CO2_40=world_tecs$area.ha*(ABC_aff_result$fit[41]+BBC_aff_result$fit[41]+SCS_aff_result$fit[41]-SCS_aff_result$fit[1])/10^6/12*44

world_tecs$reforestation.Tg.CO2_10=world_tecs$area.ha*(ABC_ref_result$fit[11]+BBC_ref_result$fit[11]+SCS_ref_result$fit[11]-SCS_ref_result$fit[1])/10^6/12*44

world_tecs$afforestation.Tg.CO2_10=world_tecs$area.ha*(ABC_aff_result$fit[11]+BBC_aff_result$fit[11]+SCS_aff_result$fit[11]-SCS_aff_result$fit[1])/10^6/12*44

world_tecs$reforestation.Tg.CO2_20=world_tecs$area.ha*(ABC_ref_result$fit[21]+BBC_ref_result$fit[21]+SCS_ref_result$fit[21]-SCS_ref_result$fit[1])/10^6/12*44

world_tecs$afforestation.Tg.CO2_20=world_tecs$area.ha*(ABC_aff_result$fit[21]+BBC_aff_result$fit[21]+SCS_aff_result$fit[21]-SCS_aff_result$fit[1])/10^6/12*44

world_tecs$reforestation.Tg.CO2_30=world_tecs$area.ha*(ABC_ref_result$fit[31]+BBC_ref_result$fit[31]+SCS_ref_result$fit[31]-SCS_ref_result$fit[1])/10^6/12*44

world_tecs$afforestation.Tg.CO2_30=world_tecs$area.ha*(ABC_aff_result$fit[31]+BBC_aff_result$fit[31]+SCS_aff_result$fit[31]-SCS_aff_result$fit[1])/10^6/12*44

world_tecs$reforestation.Tg.CO2_35=world_tecs$area.ha*(ABC_ref_result$fit[36]+BBC_ref_result$fit[36]+SCS_ref_result$fit[36]-SCS_ref_result$fit[1])/10^6/12*44

world_tecs$afforestation.Tg.CO2_35=world_tecs$area.ha*(ABC_aff_result$fit[36]+BBC_aff_result$fit[36]+SCS_aff_result$fit[36]-SCS_aff_result$fit[1])/10^6/12*44


world_tecs$reforestation.C_acum[1]=ABC_ref_result$fit[41]+BBC_ref_result$fit[41]+SCS_ref_result$fit[41]-SCS_ref_result$fit[1]
world_tecs$reforestation.C_acum[2]=ABC_ref_result$lwr[41]+BBC_ref_result$lwr[41]+SCS_ref_result$lwr[41]-SCS_ref_result$lwr[1]
world_tecs$reforestation.C_acum[3]=ABC_ref_result$upr[41]+BBC_ref_result$upr[41]+SCS_ref_result$upr[41]-SCS_ref_result$upr[1]
world_tecs$reforestation.C_acum_name[1]=c("41")

world_tecs$reforestation.C_acum[4]=sum(ABC_ref_result$fit[37:41])+sum(BBC_ref_result$fit[37:41])+sum(SCS_ref_result$fit[37:41])-SCS_ref_result$fit[1]*5
world_tecs$reforestation.C_acum[5]=sum(ABC_ref_result$lwr[37:41])+sum(BBC_ref_result$lwr[37:41])+sum(SCS_ref_result$lwr[37:41])-SCS_ref_result$lwr[1]*5
world_tecs$reforestation.C_acum[6]=sum(ABC_ref_result$upr[37:41])+sum(BBC_ref_result$upr[37:41])+sum(SCS_ref_result$upr[37:41])-SCS_ref_result$upr[1]*5
world_tecs$reforestation.C_acum_name[4]=c("37-41")

world_tecs$reforestation.C_acum[7]=sum(ABC_ref_result$fit[32:41])+sum(BBC_ref_result$fit[32:41])+sum(SCS_ref_result$fit[32:41])-SCS_ref_result$fit[1]*10
world_tecs$reforestation.C_acum[8]=sum(ABC_ref_result$lwr[32:41])+sum(BBC_ref_result$lwr[32:41])+sum(SCS_ref_result$lwr[32:41])-SCS_ref_result$lwr[1]*10
world_tecs$reforestation.C_acum[9]=sum(ABC_ref_result$upr[32:41])+sum(BBC_ref_result$upr[32:41])+sum(SCS_ref_result$upr[32:41])-SCS_ref_result$upr[1]*10
world_tecs$reforestation.C_acum_name[7]=c("32-41")

world_tecs$reforestation.C_acum[10]=sum(ABC_ref_result$fit[22:41])+sum(BBC_ref_result$fit[22:41])+sum(SCS_ref_result$fit[22:41])-SCS_ref_result$fit[1]*20
world_tecs$reforestation.C_acum[11]=sum(ABC_ref_result$lwr[22:41])+sum(BBC_ref_result$lwr[22:41])+sum(SCS_ref_result$lwr[22:41])-SCS_ref_result$lwr[1]*20
world_tecs$reforestation.C_acum[12]=sum(ABC_ref_result$upr[22:41])+sum(BBC_ref_result$upr[22:41])+sum(SCS_ref_result$upr[22:41])-SCS_ref_result$upr[1]*20
world_tecs$reforestation.C_acum_name[10]=c("22-41")

world_tecs$afforestation.C_acum[1]=ABC_aff_result$fit[41]+BBC_aff_result$fit[41]+SCS_aff_result$fit[41]-SCS_aff_result$fit[1]
world_tecs$afforestation.C_acum[2]=ABC_aff_result$lwr[41]+BBC_aff_result$lwr[41]+SCS_aff_result$lwr[41]-SCS_aff_result$lwr[1]
world_tecs$afforestation.C_acum[3]=ABC_aff_result$upr[41]+BBC_aff_result$upr[41]+SCS_aff_result$upr[41]-SCS_aff_result$upr[1]
world_tecs$afforestation.C_acum_name[1]=c("41")

world_tecs$afforestation.C_acum[4]=sum(ABC_aff_result$fit[37:41])+sum(BBC_aff_result$fit[37:41])+sum(SCS_aff_result$fit[37:41])-SCS_aff_result$fit[1]*5
world_tecs$afforestation.C_acum[5]=sum(ABC_aff_result$lwr[37:41])+sum(BBC_aff_result$lwr[37:41])+sum(SCS_aff_result$lwr[37:41])-SCS_aff_result$lwr[1]*5
world_tecs$afforestation.C_acum[6]=sum(ABC_aff_result$upr[37:41])+sum(BBC_aff_result$upr[37:41])+sum(SCS_aff_result$upr[37:41])-SCS_aff_result$upr[1]*5
world_tecs$afforestation.C_acum_name[4]=c("37-41")

world_tecs$afforestation.C_acum[7]=sum(ABC_aff_result$fit[32:41])+sum(BBC_aff_result$fit[32:41])+sum(SCS_aff_result$fit[32:41])-SCS_aff_result$fit[1]*10
world_tecs$afforestation.C_acum[8]=sum(ABC_aff_result$lwr[32:41])+sum(BBC_aff_result$lwr[32:41])+sum(SCS_aff_result$lwr[32:41])-SCS_aff_result$lwr[1]*10
world_tecs$afforestation.C_acum[9]=sum(ABC_aff_result$upr[32:41])+sum(BBC_aff_result$upr[32:41])+sum(SCS_aff_result$upr[32:41])-SCS_aff_result$upr[1]*10
world_tecs$afforestation.C_acum_name[7]=c("32-41")

world_tecs$afforestation.C_acum[10]=sum(ABC_aff_result$fit[22:41])+sum(BBC_aff_result$fit[22:41])+sum(SCS_aff_result$fit[22:41])-SCS_aff_result$fit[1]*20
world_tecs$afforestation.C_acum[11]=sum(ABC_aff_result$lwr[22:41])+sum(BBC_aff_result$lwr[22:41])+sum(SCS_aff_result$lwr[22:41])-SCS_aff_result$lwr[1]*20
world_tecs$afforestation.C_acum[12]=sum(ABC_aff_result$upr[22:41])+sum(BBC_aff_result$upr[22:41])+sum(SCS_aff_result$upr[22:41])-SCS_aff_result$upr[1]*20
world_tecs$afforestation.C_acum_name[10]=c("22-41")

write.csv(world_tecs,"EEZ_mangroveloss_final.csv")

world_tecs_com=merge(world,world_tecs,by.x="admin",by.y="country")

area_total=sum(world_tecs$area.ha)-274.5553681

all=data.frame(x=c(1,1,1,1,1,1,1,1),
                 class=c("afforestation",
                       "afforestation",
                       "afforestation",
                       "afforestation",
                       "reforestation",
                       "reforestation",
                       "reforestation",
                       "reforestation"),
               ob=c("ABC","BBC","SCS","TECS","ABC_1","BBC_1","SCS_1","TECS_1"),
               data=c(ABC_aff_result$fit[41],
                      BBC_aff_result$fit[41],
                      SCS_aff_result$fit[41]-SCS_aff_result$fit[1],
                      0,
                      ABC_ref_result$fit[41],
                      BBC_ref_result$fit[41],
                      SCS_ref_result$fit[41]-SCS_ref_result$fit[1],
                      0),
               data_lower=c(ABC_aff_result$lwr[41]+(BBC_aff_result$fit[41]+SCS_aff_result$fit[41]-SCS_aff_result$fit[1]),
                      BBC_aff_result$lwr[41]+ (SCS_aff_result$fit[41]-SCS_aff_result$fit[1]),
                      SCS_aff_result$lwr[41]-SCS_aff_result$lwr[1],
                      0,
                      ABC_ref_result$lwr[41]+(BBC_ref_result$fit[41]+SCS_ref_result$fit[41]-SCS_ref_result$fit[1]),
                      BBC_ref_result$lwr[41]+(SCS_ref_result$fit[41]-SCS_ref_result$fit[1]),
                      SCS_ref_result$lwr[41]-SCS_ref_result$lwr[1],
                      0),
               data_upper=c(ABC_aff_result$upr[41]+(BBC_aff_result$fit[41]+SCS_aff_result$fit[41]-SCS_aff_result$fit[1]),
                      BBC_aff_result$upr[41]+ (SCS_aff_result$fit[41]-SCS_aff_result$fit[1]),
                      SCS_aff_result$upr[41]-SCS_aff_result$upr[1],
                      0,
                      ABC_ref_result$upr[41]+(BBC_ref_result$fit[41]+SCS_ref_result$fit[41]-SCS_ref_result$fit[1]),
                      BBC_ref_result$upr[41]+(SCS_ref_result$fit[41]-SCS_ref_result$fit[1]),
                      SCS_ref_result$upr[41]-SCS_ref_result$upr[1],
                      0))

write.csv(all,"all_stimulate_40.csv")

all$data=all$data*area_total/10^6/12*44
all$data_lower=all$data_lower*area_total/10^6/12*44
all$data_upper=all$data_upper*area_total/10^6/12*44

p6=ggplot(all,aes(x=class,y=data,fill=ob))+
  geom_bar(color="lightgrey",stat = "identity",lwd=0.3) +
  geom_errorbar(aes(ymin= data_lower, 
                    ymax= data_upper),
                width=.2,                    
                position="identity",
                lwd=0.3)+
  mytheme+
  theme(
    axis.text.x = element_text(size=5),
    axis.text.y = element_text(size=5),
    axis.title.y=element_text(size=5),
        axis.title.x=element_blank(), 
        legend.position = "none",
        panel.background = element_rect(fill = "transparent",color=NA), 
        plot.background = element_rect(fill = "transparent", color = NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.background = element_rect(fill = "transparent"), 
        legend.box.background = element_rect(fill = "transparent"),
        axis.line = element_line(colour = "black"))+ 
  scale_y_continuous(expand = c(0,0),limits = c(0,1000))+
  ylab(expression(atop("Global carbon sequestration",paste("potential (Tg CO"[2]*"-eq)"))))+
  scale_fill_manual(values = c("#51C151","#006400","#70ABEB","#09386C","#F3D33A","#B8860B","#FCB29E","#AD3818"),
                    labels=c("ABC","ABC","BBC","BBC","SCS","SCS","TECS","TECS"),
                    name=expression(atop("Afforestation",
                                         atop(textstyle("Reforestation")))))+
  guides(alpha=FALSE)
p6

p7=ggplot(all,aes(x=class,y=data,fill=ob))+
  geom_bar(stat = "identity") +
  mytheme+
  theme(
        axis.title.x=element_blank(), 
        legend.key.size = unit(5, 'mm'),
        legend.position = "bottom",
        panel.background = element_rect(fill = "transparent",color=NA), 
        plot.background = element_rect(fill = "transparent", color = NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.background = element_rect(fill = "transparent"), 
        legend.box.background = element_rect(fill = "transparent"),
        axis.line = element_line(colour = "black"))+ 
  scale_y_continuous(expand = c(0,0),limits = c(0,500))+
  scale_fill_manual(values = c("#51C151","#006400","#70ABEB","#09386C","#F3D33A","#B8860B","#FCB29E","#AD3818"),
                    labels=c("ABC","ABC","BBC","BBC","SCS","SCS","TECS","TECS"),
                    name=expression(atop("Afforestation",
                                         atop(textstyle("Reforestation")))))+
  guides(alpha=FALSE)

leg = get_legend(p7)
p8=as_ggplot(leg)+theme(panel.background = element_rect(fill = "transparent",color=NA), 
        plot.background = element_rect(fill = "transparent", color = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.background = element_rect(fill = "transparent", color = NA),
        panel.border = element_rect(fill = "transparent", color = NA),
        rect = element_rect(fill = "transparent")) 
p8

onlyfrance=ne_countries(geounit = 'france', type = 'map_units',
                        scale = "medium", returnclass = "sf")

p9=ggplot(data = world_tecs_com) +
    geom_sf(data=world,color = "#EEEEEE", fill = "#E3E3E3",lwd=0.3)+
    geom_sf(aes(fill = reforestation.Tg.CO2_40),alpha=0.8,lwd=0.3) +
    geom_sf(data=onlyfrance,color="#EEEEEE",fill="#E3E3E3",lwd=0.3)+
    scale_fill_gradient2(low="#F3CABE",mid="#9B4C35", high="#692410", midpoint = 110, space ="Lab",na.value="white")+
  mytheme+
    theme(
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        legend.background = element_blank(),
        legend.key.width = unit(1.2, "cm"),
        legend.key.height = unit(5,"mm"),
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.justification = "right",
          legend.margin = margin(t = 2, r = 0, b = 2, l = 2, unit = "mm"))+
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0),limits = c(-48,80))+
    xlab("Longitude")+
    ylab("Latitude")+
  annotation_custom(
    ggplotGrob(p6), 
    xmin = -180, xmax = -85, ymin = -50, ymax = 15)+
  annotation_custom(
    ggplotGrob(p8), 
    xmin = -135, xmax = -80, ymin = -100, ymax = -70)+
  labs(fill=expression(atop("Carbon sequestration potential",
                                         atop(textstyle("for mangrove reforestation"),
                                             atop(textstyle(("Tg CO"[2]*"-eq")))))))
  
p9
  

ggarrange(ggarrange(p2,p3,p5,p1,nrow=1,labels = c("a","b","c","d"),legend='none',font.label=list(face="plain",family = "Helvetica",size=7,face="bold")),
          p9,ncol=1,nrow=2,labels=c("","e"),heights = c(1,2.5),font.label=list(face="plain",family = "Helvetica",size=7,face="bold"))

ggsave(path = "C:\\Users\\Mangrove reforestation and afforestation\\figures",
       filename="Fig.4.png",
       width = 180, height = 135, units = "mm",dpi=300)


```

```{r}
## Fig. S1 ###
species=data%>%
  filter(plant_nature!="")%>%
  filter(group=="restored")%>%
  filter(ABC_mean!=""|BBC_mean!=""|SCS_mean_100!="")%>%
  filter(Species_2!="")

species%>%freq_table(re_af,Species_2)

A=as.data.frame(table(species$plant_nature,species$Species_2,species$re_af))
B=as.data.frame(table(species$Species_2,species$re_af))
write.csv(B,"species_frequency.csv")

A$Var1=gsub("nature","natural",A$Var1)

A$Var1=factor(A$Var1,levels = c("plant","natural"))

p1=ggplot(A,aes(y = Freq, axis1=Var1, axis3 = Var2, axis2 = Var3)) +
    geom_alluvium(aes(fill = Var3)) +
    geom_stratum(aes(fill = Var3),alpha = .2) +
    scale_fill_brewer(type = "qual", palette = "Set1")+
    theme_void()+
    #coord_flip()+ 
    guides(fill = FALSE)+
  theme(plot.title=element_text(hjust=0.5,size=15))+
  ggrepel::geom_text_repel(
  aes(label = ifelse(after_stat(x) == 3, as.character(after_stat(stratum)), "")),
  stat = "stratum", size = 3.6, family = "Helvetica",direction = "y", nudge_x = 0.7)+
  ggrepel::geom_text_repel(
    aes(label = ifelse(after_stat(x)  == 2, as.character(after_stat(stratum)), "")),
    stat = "stratum", size = 3.6,family = "Helvetica", direction = "y", nudge_x = 0)+
    ggrepel::geom_text_repel(
    aes(label = ifelse(after_stat(x)  == 1, as.character(after_stat(stratum)), "")),
    stat = "stratum", size = 3.6,family = "Helvetica", direction = "y", nudge_x = 0)
p1

ggsave(path = "C:\\Users\\Mangrove reforestation and afforestation\\figures",
       filename="Fig.S1.png",
       width = 180, height = 170, units = "mm",dpi=300)

```

```{r}
### Fig. S8 ###
library("nlraa")

ABC_ref=ABC%>%filter(re_af=="reforestation")%>%arrange(Age)%>%filter(Age<=40)
ABC_aff=ABC%>%filter(re_af=="afforestation")%>%arrange(Age)%>%filter(Age<=40)

# VB
VB=function(x,Asym,K,t0) Asym*(1-exp(-K*(x-t0)))
fit_ref_vb = nls(ABC_mean~VB(Age,Asym,K,t0),data=ABC_ref,start=list(Asym=115.72,K=1,t0=2.43))
fit_aff_vb = nls(ABC_mean~VB(Age,Asym,K,t0),data=ABC_aff,start=list(Asym=91.55,K=1,t0=2.43))

# Gompertz Growth Model
Gompertz = function(x, Asym, b2, b3) Asym*exp(-b2*b3^x)
fit_ref_g = nls(ABC_mean~Gompertz(Age,Asym,b2,b3),data=ABC_ref,start=list(Asym=115.72,b2=1.4,b3=0.95))
fit_aff_g = nls(ABC_mean~Gompertz(Age,Asym,b2,b3),data=ABC_aff,start=list(Asym=91.55,b2=1.4,b3=0.9))

# Chapman-Richards Model
chapm = function(x,Asym,b,c)Asym*(1-exp(-b*x))^c
fit_ref_cr= nls(ABC_mean~chapm(Age,Asym,b,c),data=ABC_ref,start=list(Asym=125,b=0.05,c=1)) #100
fit_aff_cr = nls(ABC_mean~chapm(Age,Asym,b,c),data=ABC_aff,start=list(Asym=90,b=0.1,c=2)) #100

a=print(IC_tab(fit_ref_vb,fit_ref_g,fit_ref_cr), digits = 2)
b=print(IC_tab(fit_aff_vb,fit_aff_g,fit_aff_cr), digits = 2)

rownames(a)[rownames(a)=="1"]="Von Bertalanffy model"
rownames(a)[rownames(a)=="2"]="Gompertz growth model"
rownames(a)[rownames(a)=="3"]="Chapman-Richards model"

rownames(b)[rownames(b)=="1"]="Von Bertalanffy model"
rownames(b)[rownames(b)=="2"]="Gompertz growth model"
rownames(b)[rownames(b)=="3"]="Chapman-Richards model"

ABC_ref_r=data.frame(model=rownames(a),AIC=a$AIC)
ABC_aff_r=data.frame(model=rownames(b),AIC=b$AIC)

BBC_ref=BBC%>%filter(re_af=="reforestation")%>%arrange(Age)%>%filter(Age<=40)
BBC_aff=BBC%>%filter(re_af=="afforestation")%>%arrange(Age)%>%filter(Age<=40)

# VB
VB=function(x,Asym,K,t0) Asym*(1-exp(-K*(x-t0)))
fit_ref_vb = nls(BBC_mean~VB(Age,Asym,K,t0),data=BBC_ref,start=list(Asym=80,K=1,t0=2.43))
fit_aff_vb = nls(BBC_mean~VB(Age,Asym,K,t0),data=BBC_aff,start=list(Asym=90,K=1,t0=3))

# Gompertz Growth Model
Gompertz = function(x, Asym, b2, b3) Asym*exp(-b2*b3^x)
fit_ref_g = nls(BBC_mean~Gompertz(Age,Asym,b2,b3),data=BBC_ref,start=list(Asym=95.56,b2=2.74,b3=0.96))
fit_aff_g = nls(BBC_mean~Gompertz(Age,Asym,b2,b3),data=BBC_aff,start=list(Asym=75,b2=2,b3=0.96))

# Chapman-Richards Model
chapm = function(x,Asym,b,c)Asym*(1-exp(-b*x))^c
fit_ref_cr= nls(BBC_mean~chapm(Age,Asym,b,c),data=BBC_ref,start=list(Asym=95.56,b=0.1,c=1)) #100
fit_aff_cr = nls(BBC_mean~chapm(Age,Asym,b,c),data=BBC_aff,start=list(Asym=50, b=0.1, c=1)) #100

a=print(IC_tab(fit_ref_vb,fit_ref_g,fit_ref_cr), digits = 2)
b=print(IC_tab(fit_aff_vb,fit_aff_g,fit_aff_cr), digits = 2)

rownames(a)[rownames(a)=="1"]="Von Bertalanffy model"
rownames(a)[rownames(a)=="2"]="Gompertz growth model"
rownames(a)[rownames(a)=="3"]="Chapman-Richards model"

rownames(b)[rownames(b)=="1"]="Von Bertalanffy model"
rownames(b)[rownames(b)=="2"]="Gompertz growth model"
rownames(b)[rownames(b)=="3"]="Chapman-Richards model"

BBC_ref_r=data.frame(model=rownames(a),AIC=a$AIC)
BBC_aff_r=data.frame(model=rownames(b),AIC=b$AIC)


SCS=data%>% drop_na(SCS_mean_100)%>%
  filter(group!="intact")%>%mutate_all(type.convert)

TECS=data%>% drop_na(TECS_mean)%>%
  filter(group!="intact")%>%mutate_all(type.convert)

SCS_ref=SCS%>%filter(re_af=="reforestation")%>%arrange(Age)
SCS_aff=SCS%>%filter(re_af=="afforestation")%>%arrange(Age)

# VB
VB=function(x,Asym,K,t0) Asym*(1-exp(-K*(x-t0)))
fit_ref_vb = nls(SCS_mean_100~VB(Age,Asym,K,t0),data=SCS_ref,start=list(Asym=350,K=0.05,t0=70))
fit_aff_vb = nls(SCS_mean_100~VB(Age,Asym,K,t0),data=SCS_aff,start=list(Asym=150,K=0.1,t0=10))


# Gompertz Growth Model
Gompertz = function(x, Asym, b2, b3) Asym*exp(-b2*b3^x)
fit_ref_g = nls(SCS_mean_100~Gompertz(Age,Asym,b2,b3),data=SCS_ref,start=list(Asym=510,b2=0.67,b3=0.9))
fit_aff_g = nls(SCS_mean_100~Gompertz(Age,Asym,b2,b3),data=SCS_aff,start=list(Asym=200,b2=1.4,b3=0.9))


a=print(IC_tab(fit_ref_vb,fit_ref_g), digits = 2)
b=print(IC_tab(fit_aff_vb,fit_aff_g), digits = 2)


rownames(a)[rownames(a)=="1"]="Von Bertalanffy model"
rownames(a)[rownames(a)=="2"]="Gompertz growth model"

rownames(b)[rownames(b)=="1"]="Von Bertalanffy model"
rownames(b)[rownames(b)=="2"]="Gompertz growth model"

SCS_ref_r=data.frame(model=rownames(a),AIC=a$AIC)
SCS_aff_r=data.frame(model=rownames(b),AIC=b$AIC)

TECS_ref=TECS%>%filter(re_af=="reforestation")%>%arrange(Age)
TECS_aff=TECS%>%filter(re_af=="afforestation")%>%arrange(Age)


# VB
VB=function(x,Asym,K,t0) Asym*(1-exp(-K*(x-t0)))
fit_ref_vb = nls(TECS_mean~VB(Age,Asym,K,t0),data=TECS_ref,start=list(Asym=500,K=0.1,t0=100))
fit_aff_vb = nls(TECS_mean~VB(Age,Asym,K,t0),data=TECS_aff,start=list(Asym=250,K=0.1,t0=10))

# Gompertz Growth Model
Gompertz = function(x, Asym, b2, b3) Asym*exp(-b2*b3^x)
fit_ref_g = nls(TECS_mean~Gompertz(Age,Asym,b2,b3),data=TECS_ref,start=list(Asym=410,b2=0.67,b3=0.9))
fit_aff_g = nls(TECS_mean~Gompertz(Age,Asym,b2,b3),data=TECS_aff,start=list(Asym=200,b2=1.4,b3=0.9))

# Chapman-Richards Model
chapm = function(x,Asym,b,c)Asym*(1-exp(-b*x))^c
fit_ref_cr= nls(TECS_mean~chapm(Age,Asym,b,c),data=TECS_ref,start=list(Asym=530,b=0.1,c=1)) #100
fit_aff_cr = nls(TECS_mean~chapm(Age,Asym,b,c),data=TECS_aff,start=list(Asym=224,b=0.03,c=0.5)) #100


a=print(IC_tab(fit_ref_vb,fit_ref_g), digits = 2)
b=print(IC_tab(fit_aff_vb,fit_aff_g), digits = 2)

rownames(a)[rownames(a)=="1"]="Von Bertalanffy model"
rownames(a)[rownames(a)=="2"]="Gompertz growth model"

rownames(b)[rownames(b)=="1"]="Von Bertalanffy model"
rownames(b)[rownames(b)=="2"]="Gompertz growth model"

TECS_ref_r=data.frame(model=rownames(a),AIC=a$AIC)
TECS_aff_r=data.frame(model=rownames(b),AIC=b$AIC)

ref_r=cbind(rbind(ABC_ref_r,BBC_ref_r,SCS_ref_r,TECS_ref_r),type=c(rep("ABC",3),rep("BBC",3),rep("SCS",2),rep("TECS",2)))
aff_r=cbind(rbind(ABC_aff_r,BBC_aff_r,SCS_aff_r,TECS_aff_r),type=c(rep("ABC",3),rep("BBC",3),rep("SCS",2),rep("TECS",2)))

r=cbind(rbind(ref_r,aff_r),group=c(rep("reforestation",10),rep("afforestation",10)))

mytheme=theme_bw()+
  theme(axis.text = element_text(family = "Helvetica",size=6),
  axis.text.x=element_text(face="plain",family = "Helvetica",size=6), 
        axis.text.y=element_text(face="plain",family = "Helvetica",size=6), 
        axis.title.y=element_text(face="plain",family = "Helvetica",size=6), 
        axis.title.x=element_text(face="plain",family = "Helvetica",size=6),  
        plot.title=element_text(hjust=0.5,vjust=0,family = "Helvetica",size=6),
        legend.text = element_text(family = "Helvetica",size=6),
        legend.title = element_text(face="plain",family = "Helvetica",size=6),
        panel.border = element_rect(fill=NA, size=0.4),
        legend.position = "bottom",
        strip.text.x = element_text(family = "Helvetica",size=6),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(colour = 'black', size = 0.3),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-5,0,-5,0))


a=ggplot(ref_r,aes(x=model,y=AIC,color=model))+
  geom_point(size=3,alpha=0.6)+ 
  mytheme+
    theme(
        axis.text.x=element_blank(),
        axis.title.x=element_text(face="plain",color="white"),
        legend.title=element_blank(),
        legend.position = "bottom",
        panel.grid.major =element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(fill="transparent",color=NA))+
  facet_wrap(~type,scales = "free_y",nrow=4)+
  ylab("AIC")

b=ggplot(aff_r,aes(x=model,y=AIC,color=model))+
  geom_point(size=3,alpha=0.6)+ 
  mytheme+
    theme(
          axis.title.y=element_text(color="white"),
        axis.text.x=element_blank(),
        axis.title.x=element_text(face="plain",color="white"),
        legend.title=element_blank(),
        legend.position = "bottom",
        panel.grid.major =element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(fill="transparent",color=NA))+
  facet_wrap(~type,scales = "free_y",nrow=4)+
  ylab("AIC")

ggarrange(a,b,ncol=2,labels=c("a","b"),common.legend = T,legend = "bottom",font.label=list(face="plain",family = "Helvetica",size=6,face="bold"))

ggsave(path = "C:\\Users\\Mangrove reforestation and afforestation\\figures",
       filename="Fig.S8.png",
       width = 110, height = 120, units = "mm")
```


```{r}
### Fig. S2 ###
data=read.csv("Supplementary Data.csv",stringsAsFactors = FALSE,fileEncoding="latin1")

data=data%>%
  filter(ID<1000)%>%  # delete abnormal data
  filter(re_af!="")%>%
  mutate(re_af=factor(re_af,level=c("afforestation","reforestation")))

colnames(data)[c(19:23,25,28:33,35)]=c("BC_mean","ABC_mean","BBC_mean",
                                       "SCS_mean","SCS_mean_100","SC_mean","TECS_mean",
                                       "salinity_pore",
                                       "sand","silt","clay",
                                       "TN_mean","N.concentration_mean")  ## simplify column names

mytheme=theme_bw()+
  theme(axis.text = element_text(family = "Helvetica",size=7),
  axis.text.x=element_text(face="plain",family = "Helvetica",size=7), 
        axis.text.y=element_text(face="plain",family = "Helvetica",size=7), 
        axis.title.y=element_text(face="plain",family = "Helvetica",size=7), 
        axis.title.x=element_text(face="plain",family = "Helvetica",size=7),  
        plot.title=element_text(hjust=0.5,vjust=0,family = "Helvetica",size=7),
        legend.text = element_text(family = "Helvetica",size=7),
        legend.title = element_text(face="plain",family = "Helvetica",size=7),
        panel.border = element_rect(fill=NA, size=0.4),
        legend.position = "bottom",
        strip.text.x = element_text(family = "Helvetica",size=7),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(colour = 'black', size = 0.3))

p6=ggboxplot(data,x="re_af",y="silt",
          color = "re_af", 
          add = "jitter", 
          legend = "none",
          add.params = list(alpha = 0.5))+
  stat_compare_means(size=3,label = "p.signif",label.x=1.5,label.y = 85,hide.ns = TRUE)+
  mytheme+
   theme(
        axis.text.x=element_blank(), 
        axis.title.x=element_text(face="plain",color="white"), 
        plot.title=element_text(hjust=0.5,colour = "white"),
        legend.title=element_blank(),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank()) +
  scale_y_continuous(limits = c(0,90))+
  ylab("sediment silt content / %")

p7=ggboxplot(data,x="re_af",y="sand",
          color = "re_af", 
          add = "jitter", 
          legend = "none",
          add.params = list(alpha = 0.5))+
  stat_compare_means(size=3,label = "p.signif",label.x=1.5,label.y = 85,hide.ns = TRUE)+
  mytheme+
  theme(
        axis.text.x=element_blank(), 
        axis.title.x=element_text(face="plain",color="white"), 
        plot.title=element_text(hjust=0.5,colour = "white"),
        legend.title=element_blank(),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank())+
  scale_y_continuous(limits = c(0,90))+
  ylab("sediment sand content / %")

p8=ggboxplot(data,x="re_af",y="clay",
          color = "re_af", 
          add = "jitter", 
          legend = "none",
          add.params = list(alpha = 0.5))+
  mytheme+
  stat_compare_means(size=3,label = "p.signif",label.x=1.5,label.y = 65,hide.ns = TRUE)+
  theme(
        axis.text.x=element_blank(), 
        axis.title.x=element_text(face="plain",color="white"), 
        plot.title=element_text(hjust=0.5,colour = "white"),
        legend.title=element_blank(),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank())+
  scale_y_continuous(limits = c(0,70))+
  ylab("sediment clay content / %")

data=data%>%filter(group=="initial")

P1=ggboxplot(data,x="re_af",y="initial_SC",
          color = "re_af", 
          add = "jitter", 
          legend = "none",
          add.params = list(alpha = 0.5))+
  stat_compare_means(size=3,label = "p.signif",label.x=1.5,label.y = 19,hide.ns = TRUE)+
  mytheme+
    theme(
        axis.text.x=element_blank(), 
        axis.title.x=element_text(face="plain",color="white"), 
        plot.title=element_text(hjust=0.5,colour = "white"),
        legend.title=element_blank(),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank())+
  scale_y_continuous(limits = c(0,20))+
  ylab("initial sediment TOC content / %")


P2=ggboxplot(data,x="re_af",y="initial_N",
          color = "re_af", 
          add = "jitter", 
          legend = "none",
          add.params = list(alpha = 0.5))+
  stat_compare_means(size=3,label = "p.signif",label.x=1.5,hide.ns = TRUE)+
  mytheme+theme(
        axis.text.x=element_blank(), 
        axis.title.x=element_text(face="plain",color="white"), 
        plot.title=element_text(hjust=0.5,colour = "white"),
        legend.title=element_blank(),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank())+
  scale_y_continuous(limits = c(0,0.5))+
  ylab("initial sediment N content / %")


P3=ggboxplot(data,x="re_af",y="initial_CN",
          color = "re_af", 
          add = "jitter", 
          legend = "none",
          add.params = list(alpha = 0.5))+
  stat_compare_means(size=3,label = "p.signif",label.x=1.5,label.y=39,hide.ns = TRUE)+
  mytheme+
  theme(
        axis.text.x=element_blank(), 
        axis.title.x=element_text(face="plain",color="white"), 
        plot.title=element_text(hjust=0.5,colour = "white"),
        legend.title=element_blank(),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank())+
  scale_y_continuous(limits = c(0,40))+
  ylab("initial sediment C:N")


P4=ggboxplot(data,x="re_af",y="initial_SC",
          color = "re_af", 
          add = "jitter", 
          legend = "none",
          add.params = list(alpha = 0.5))+
  stat_compare_means(size=5,label = "p.signif",label.x=1.5,hide.ns = TRUE)+
  mytheme+
  theme(
        axis.text.x=element_blank(), 
        axis.title.x=element_text(face="plain",color="white"), 
        plot.title=element_text(hjust=0.5,colour = "white"),
        legend.title=element_blank(),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank())+
  ylab("initial sediment TOC content / %")


ggarrange(p7,p6,p8,P1,P2,P3, ncol = 3, nrow =2 ,labels="auto",common.legend = TRUE,legend="bottom",font.label=list(face="plain",family = "Helvetica",size=7,face="bold"))

ggsave("Fig.S2.png", 
       path ="C:\\Users\\Mangrove reforestation and afforestation\\figures",
       width = 180,height = 140,units = c("mm"),dpi = 300)
```

```{r}
### Fig. S6 ###
data=read.csv("Supplementary Data of Fig. S6.csv",stringsAsFactors = FALSE,fileEncoding = 'GB18030')

data=data%>%
  filter(plant_nature!="")%>%
  filter(Species_SP=="K")%>%
  mutate(re_af=factor(re_af,levels = c("reforestation","afforestation")))

ABC=data%>% drop_na(ABC_mean)%>%mutate_all(type.convert)

BBC=data%>% drop_na(BBC_mean)%>%mutate_all(type.convert)

SCS=data%>% drop_na(SCS_mean_100)%>%mutate_all(type.convert)

mytheme=theme_bw()+
  theme(axis.text = element_text(family = "Helvetica",size=7),
  axis.text.x=element_text(face="plain",family = "Helvetica",size=7), 
        axis.text.y=element_text(face="plain",family = "Helvetica",size=7), 
        axis.title.y=element_text(face="plain",family = "Helvetica",size=7), 
        axis.title.x=element_text(face="plain",family = "Helvetica",size=7),  
        plot.title=element_text(hjust=0.5,vjust=0,family = "Helvetica",size=7),
        legend.text = element_text(family = "Helvetica",size=7),
        legend.title = element_text(face="plain",family = "Helvetica",size=7),
        panel.border = element_rect(fill=NA, size=0.4),
        legend.position = "bottom",
        strip.text.x = element_text(family = "Helvetica",size=7),
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(colour = 'black', size = 0.3),
      # legend.key.size = unit(0.5,"mm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-5,0,-5,0))


ABC$ID=factor(ABC$ID,levels=c("4 yr, newly-sedimentary tidal flat, Vietnam (20.2°N)",
                                 "5 yr, newly-sedimentary tidal flat, Vietnam (20.6°N)",
                                 "6 yr, newly-sedimentary tidal flat, Vietnam (20.6°N)",
                                 "3 yr, abandonded ponds, Vietnam (20.2°N)",
                                 "3 yr, abandonded ponds, China (22.7°N)",
                                 "5 yr, abandonded ponds, India (20.4°N)"))

BBC$ID=factor(BBC$ID,levels=c("3 yr, newly-sedimentary tidal flat, Vietnam (20.7°N)",
                                 "4 yr, newly-sedimentary tidal flat, Vietnam (20.2°N)",
                                 "5 yr, newly-sedimentary tidal flat, Vietnam (20.7°N)",
                                 "3 yr, abandonded ponds, Vietnam (20.2°N)",
                                 "3 yr, abandonded ponds, China (22.7°N)",
                                 "5 yr, abandonded ponds, India (20.4°N)"))


nom3 = bartlett.test(ABC$ABC_mean~ABC$re_af)
nom3$p.value
nom3$p.value>0.05

oneway3=aov(ABC$ABC_mean~ABC$re_af)
anova(oneway3)
library("agricolae")
out3 = LSD.test(oneway3,"ABC$re_af",p.adj="none")
mar3=out3$groups
rownamemar3=row.names(mar3)
newmar3=data.frame(rownamemar3,mar3[,1],mar3$groups)
sort3=newmar3[order(newmar3$rownamemar3),]
name=row.names(mar3)  
mean3=out3$means[,1]
sd3=out3$means[,2]
marker3=sort3$mar3.groups
plotdata3=data.frame(name,mean3,sd3,marker3)

P1=ggplot(plotdata3,aes(x=name,y=mean3))+
          geom_jitter(data=ABC,aes(x=ABC$re_af,y=ABC$ABC_mean,size=ABC$Age,shape=ABC$ID),
                      color="grey",alpha=0.6,size=2,position = position_jitter(0.21))+
          geom_point(aes(color=name),position=position_dodge(0.6),width=0.6,stat="identity",size=3)+
          geom_errorbar(aes(ymin=mean3-sd3,ymax=mean3+sd3,color=name),
                        position=position_dodge(0.6),width=0.2,lwd=0.4)+
          geom_text(aes(x=name,y=30,color=name,label=marker3),
                    size=3,position= position_dodge(0.6))+
        # theme_bw()+
      scale_shape_manual(values = c("4 yr, newly-sedimentary tidal flat, Vietnam (20.2°N)"=1,
                                 "5 yr, newly-sedimentary tidal flat, Vietnam (20.6°N)"=2,
                                 "6 yr, newly-sedimentary tidal flat, Vietnam (20.6°N)"=3,
                                 "3 yr, abandonded ponds, Vietnam (20.2°N)"=15,
                                 "3 yr, abandonded ponds, China (22.7°N)"=17,
                                 "5 yr, abandonded ponds, India (20.4°N)"=18))+
      mytheme+
    theme(
        axis.title.x=element_blank(),
        legend.title=element_blank(),
        legend.position = "bottom",
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank())+
       ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))+
      guides(
      shape = guide_legend(nrow = 3,
                                title="Detailed site information",
                                override.aes = list(size = c(2,2))))+
      ggtitle("Aboveground biomass carbon")

nom3 = bartlett.test(BBC$BBC_mean~BBC$re_af)
nom3$p.value
    
nom3$p.value>0.05
oneway3=aov(BBC$BBC_mean~BBC$re_af)
anova(oneway3)
library("agricolae")
out3 = LSD.test(oneway3,"BBC$re_af",p.adj="none")
mar3=out3$groups
rownamemar3=row.names(mar3)
newmar3=data.frame(rownamemar3,mar3[,1],mar3$groups)
sort3=newmar3[order(newmar3$rownamemar3),]
    
name=c("afforestation","reforestation")  
mean3=out3$means[,1]
sd3=out3$means[,2]
marker3=sort3$mar3.groups
plotdata3=data.frame(name,mean3,sd3,marker3)

P2=ggplot(plotdata3,aes(x=name,y=mean3))+
          geom_jitter(data=BBC,aes(x=BBC$re_af,y=BBC$BBC_mean,size=BBC$Age,shape=BBC$ID),
                      color="grey",alpha=0.6,size=2,position = position_jitter(0.21))+
          geom_point(aes(color=name),position=position_dodge(0.6),width=0.6,stat="identity",size=2)+
          geom_errorbar(aes(ymin=mean3-sd3,ymax=mean3+sd3,color=name),
                        position=position_dodge(0.6),width=0.2,lwd=0.4)+
          geom_text(aes(x=name,y=2.8,color=name,label=marker3),
                    size=3,position= position_dodge(0.6))+
        theme_bw()+
            scale_shape_manual(values = c( "3 yr, newly-sedimentary tidal flat, Vietnam (20.7°N)"=4,
                                 "4 yr, newly-sedimentary tidal flat, Vietnam (20.2°N)"=1,
                                 "5 yr, newly-sedimentary tidal flat, Vietnam (20.7°N)"=5,
                                 "3 yr, abandonded ponds, Vietnam (20.2°N)"=15,
                                 "3 yr, abandonded ponds, China (22.7°N)"=17,
                                 "5 yr, abandonded ponds, India (20.4°N)"=18))+
      guides(
             shape = guide_legend(nrow = 5,
                                title="Detailed site information",
                                override.aes = list(size = c(5,5))))+
      mytheme+
    theme(axis.title.x=element_blank(), 
        legend.title=element_blank(),
        legend.position = "bottom",
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank())+
       ylab(expression(paste("Carbon density (Mg C ha"^-1*")")))+
      ggtitle("Belowground biomass carbon")
    
P3=ggplot(data,aes(x=Age,y=BC_mean,shape=ID))+
      geom_point()+
      scale_shape_manual(values = c( "3 yr, newly-sedimentary tidal flat, Vietnam (20.7°N)"=4,
                                 "4 yr, newly-sedimentary tidal flat, Vietnam (20.2°N)"=1,
                                 "5 yr, newly-sedimentary tidal flat, Vietnam (20.7°N)"=5,
                                 "5 yr, newly-sedimentary tidal flat, Vietnam (20.6°N)"=2,
                                 "6 yr, newly-sedimentary tidal flat, Vietnam (20.6°N)"=3,
                                 "3 yr, abandonded ponds, Vietnam (20.2°N)"=15,
                                 "3 yr, abandonded ponds, China (22.7°N)"=17,
                                 "5 yr, abandonded ponds, India (20.4°N)"=18))+
      guides(color="none",
             shape = guide_legend(nrow = 5,
                                title="Detailed site information",
                                override.aes = list(size = c(2,2))))+
      mytheme+
      theme(
        axis.title.x=element_blank(), 
        legend.title=element_blank(),
        legend.text = element_text(size=7),
        legend.position = "bottom",
        panel.grid.major =element_blank(), 
        panel.grid.minor = element_blank())
    
leg = get_legend(P3)
    
P4=as_ggplot(leg)+
      theme(
              panel.background = element_rect(fill = "transparent",color=NA), 
        plot.background = element_rect(fill = "transparent", color = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.background = element_rect(fill = "transparent", color = NA),
        panel.border = element_rect(fill = "transparent", color = NA),
        rect = element_rect(fill = "transparent")) 


ggarrange(ggarrange(P1,P2,nrow=1,labels=c("a","b"),legend="none"),font.label=list(face="plain",family = "Helvetica",size=7,face="bold"),
          P4,nrow=2,heights=c(2,1),labels="")

ggsave("Fig.S6.png", 
       path ="C:\\Users\\Mangrove reforestation and afforestation\\figures",
         width = 150,height = 90,units = c("mm"),dpi = 300)
```





